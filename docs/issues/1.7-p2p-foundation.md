# Issue 1.7: P2P Foundation (peer.js)

**Sprint:** 1
**Priority:** CRITICAL
**Estimate:** 8 hours
**Status:** TODO

## Description
Set up peer.js P2P connections with host authority model. Support N players (2-8) from day 1.

## Tasks
- [ ] Initialize peer.js (host creates Peer object)
- [ ] Generate shareable link with peer ID
- [ ] Client connection via URL parameter
- [ ] Support N players (2-8) from day 1
- [ ] Broadcast state updates (host → all clients)
- [ ] Basic connection status indicator
- [ ] Handle peer connection/disconnection events

## Architecture: Host Authority Model
- **Host:** First player is the source of truth
- **State mutations:** All changes happen on host, then broadcast
- **Clients:** Receive state updates, send actions to host
- **Unidirectional sync:** host → clients only

## Type Safety
```javascript
// @ts-check

/**
 * @typedef {Object} PeerConnection
 * @property {string} peerId - Unique peer ID
 * @property {boolean} isHost - Whether this peer is host
 * @property {string[]} connectedPeers - IDs of connected peers
 */

/**
 * @typedef {Object} NetworkMessage
 * @property {'state_update'|'action'|'player_joined'|'player_left'} type
 * @property {*} payload - Message payload
 * @property {number} timestamp - Message timestamp
 */

/**
 * Initializes P2P connection as host
 * @returns {Promise<PeerConnection>} Connection info
 */

/**
 * Connects to host as client
 * @param {string} hostPeerId - Host's peer ID from URL
 * @returns {Promise<PeerConnection>} Connection info
 */

/**
 * Broadcasts state to all connected peers (host only)
 * @param {GameState} state - Current game state
 * @returns {void}
 */
```

## Files to Create/Modify
- `src/network/p2p.js` - P2P connection management
- `tests/network/p2p.test.js` - Mock peer connection tests
- Add peer.js CDN to `index.html`

## CDN Setup
```html
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
```

## Acceptance Criteria
- [ ] Host can create peer and get shareable link
- [ ] Clients can connect via URL parameter
- [ ] Connection status visible (connected/disconnected)
- [ ] Host can broadcast state to all clients
- [ ] Supports 2-8 players dynamically
- [ ] Connection/disconnection events handled
- [ ] Tests with mocked peer connections
- [ ] Type checking passes (`npm run typecheck`)

## URL Format
```
# Host creates peer, gets ID: "abc123"
https://example.com/

# Shareable link for clients:
https://example.com/?host=abc123
```

## Testing Strategy
- Mock PeerJS objects in tests
- Test state broadcast logic
- Test player join/leave events
- Defer full integration tests to Sprint 4

## Notes
- **Reconnection logic deferred to post-MVP**
- Focus on basic connection establishment
- Host authority enforced from day 1
