# Issue 1.8: Game State Machine (TDD)

**Sprint:** 1
**Priority:** CRITICAL
**Estimate:** 10 hours
**Status:** TODO

## Description
Implement the game state machine that manages phase transitions, turn progression, and ready-up logic.

## Tests First (Write These Before Implementation)
- [ ] State transitions: LOBBY → CARD_DEAL → READY_UP → TOKEN_TRADING → TURN_COMPLETE
- [ ] Turn progression (1 → 2 → 3 → 4)
- [ ] Ready-up logic (all players must ready before trading)
- [ ] Turn completion logic (all players proceed to advance)
- [ ] Game reset after END_GAME (back to CARD_DEAL, not LOBBY)

## Implementation Tasks
- [ ] State structure (players, deck, cards, tokens, turn, phase)
- [ ] Phase state machine with transitions
- [ ] Ready-up tracking (per-player)
- [ ] Turn advancement logic
- [ ] State broadcast integration (host authority)
- [ ] "Ready for Next Game" handling

## Game Phases
```
LOBBY (initial join only)
  ↓
CARD_DEAL → READY_UP → TOKEN_TRADING → TURN_COMPLETE
    ↑                                         ↓
    └──────────── (repeat 4 turns) ──────────┘
                          ↓ (after turn 4)
                       END_GAME
                          ↓
            "Ready for Next Game" button
                          ↓
                   (back to CARD_DEAL)
```

## Type Safety
```javascript
// @ts-check

/**
 * @typedef {'LOBBY'|'CARD_DEAL'|'READY_UP'|'TOKEN_TRADING'|'TURN_COMPLETE'|'END_GAME'} GamePhase
 */

/**
 * @typedef {Object} GameState
 * @property {GamePhase} phase - Current game phase
 * @property {number} turn - Current turn (1-4)
 * @property {Player[]} players - All players (2-8)
 * @property {Card[]} deck - Shuffled deck
 * @property {Card[]} communityCards - Shared cards (max 5)
 * @property {Token[]} tokens - Available tokens
 * @property {'blue'|'red'} cardBackColor - Randomized once per game
 * @property {Object.<string, boolean>} readyStatus - Map of playerId to ready state
 */

/**
 * Advances game to next phase
 * @param {GameState} state - Current state
 * @returns {GameState} Updated state
 */

/**
 * Checks if all players are ready
 * @param {GameState} state - Current state
 * @returns {boolean} True if all ready
 */

/**
 * Resets game for next round (after END_GAME)
 * @param {GameState} state - Current state
 * @returns {GameState} Fresh game state (keeps players, new cards/tokens)
 */
```

## Files to Create/Modify
- `src/gameState.js` - State machine implementation
- `tests/gameState.test.js` - Comprehensive state transition tests

## Acceptance Criteria
- [ ] All phase transitions work correctly
- [ ] Turn advances 1 → 2 → 3 → 4
- [ ] Ready-up blocks progression until all ready
- [ ] Turn completion blocks until all proceed
- [ ] After END_GAME, "Ready for Next Game" goes to CARD_DEAL
- [ ] State immutability (returns new state, doesn't mutate)
- [ ] All tests pass (`npm test`)
- [ ] >80% code coverage
- [ ] Type checking passes (`npm run typecheck`)

## State Transition Rules
- **LOBBY → CARD_DEAL:** Host starts game (min 2 players)
- **CARD_DEAL → READY_UP:** Cards dealt automatically
- **READY_UP → TOKEN_TRADING:** All players marked ready
- **TOKEN_TRADING → TURN_COMPLETE:** All players clicked proceed
- **TURN_COMPLETE → CARD_DEAL:** Turn < 4, advance to next turn
- **TURN_COMPLETE → END_GAME:** Turn === 4, show results
- **END_GAME → CARD_DEAL:** All players clicked "Ready for Next Game"

## Edge Cases
- Late joiner during game → show LOBBY, wait for next game
- Player disconnect during ready-up (deferred to post-MVP)
- Invalid phase transitions (should throw error or no-op)
