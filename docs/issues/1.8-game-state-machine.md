# Issue 1.8: Game State Machine (TDD)

**Sprint:** 1
**Priority:** CRITICAL
**Estimate:** 10 hours
**Status:** ✅ COMPLETE

## Description
Implement the game state machine that manages phase transitions, turn progression, and ready-up logic.

## Tests First (Write These Before Implementation)
- [x] State transitions: LOBBY → READY_UP → TOKEN_TRADING → TURN_COMPLETE
- [x] Turn progression (1 → 2 → 3 → 4)
- [x] Ready-up logic (all players must ready before trading)
- [x] Turn completion logic (all players proceed to advance)
- [x] Game reset after END_GAME (back to READY_UP, not LOBBY)

## Implementation Tasks
- [x] State structure (players, deck, cards, tokens, turn, phase)
- [x] Phase state machine with transitions
- [x] Ready-up tracking (per-player)
- [x] Turn advancement logic
- [x] State broadcast integration (host authority)
- [x] "Ready for Next Game" handling

## Game Phases
```
LOBBY (initial join only)
  ↓
READY_UP → TOKEN_TRADING → TURN_COMPLETE
    ↑                           ↓
    └───── (repeat 4 turns) ────┘
                ↓ (after turn 4)
             END_GAME
                ↓
  "Ready for Next Game" button
                ↓
         (back to READY_UP)
```

**Note:** CARD_DEAL phase was removed. Cards are dealt instantly when entering READY_UP phase. The ready-up action is what players do during this phase after seeing their cards.

## Type Safety
```javascript
// @ts-check

/**
 * @typedef {'LOBBY'|'READY_UP'|'TOKEN_TRADING'|'TURN_COMPLETE'|'END_GAME'} GamePhase
 */

/**
 * @typedef {Object} GameState
 * @property {GamePhase} phase - Current game phase
 * @property {number} turn - Current turn (1-4)
 * @property {Player[]} players - All players (2-8)
 * @property {Card[]} deck - Shuffled deck
 * @property {Card[]} communityCards - Shared cards (max 5)
 * @property {Token[]} tokens - Available tokens
 * @property {'blue'|'red'} cardBackColor - Randomized once per game
 * @property {Object.<string, boolean>} readyStatus - Map of playerId to ready state
 */

/**
 * Advances game to next phase
 * @param {GameState} state - Current state
 * @returns {GameState} Updated state
 */

/**
 * Checks if all players are ready
 * @param {GameState} state - Current state
 * @returns {boolean} True if all ready
 */

/**
 * Resets game for next round (after END_GAME)
 * @param {GameState} state - Current state
 * @returns {GameState} Fresh game state (keeps players, new cards/tokens)
 */
```

## Files to Create/Modify
- `src/gameState.js` - State machine implementation ✅
- `tests/gameState.test.js` - Comprehensive state transition tests ✅

## Acceptance Criteria
- [x] All phase transitions work correctly
- [x] Turn advances 1 → 2 → 3 → 4
- [x] Ready-up blocks progression until all ready
- [x] Turn completion blocks until all proceed
- [x] After END_GAME, "Ready for Next Game" goes to READY_UP
- [x] State immutability (returns new state, doesn't mutate)
- [x] All tests pass (`npm test`)
- [x] >80% code coverage
- [x] Type checking passes (`npm run typecheck`)

## State Transition Rules
- **LOBBY → READY_UP:** Host starts game (min 2 players), deals hole cards + turn 1 community cards (0)
- **READY_UP → TOKEN_TRADING:** All players marked ready
- **TOKEN_TRADING → TURN_COMPLETE:** All players clicked proceed
- **TURN_COMPLETE → READY_UP:** Turn < 4, advance to next turn, deal community cards, **reset readyStatus**
- **TURN_COMPLETE → END_GAME:** Turn === 4, show results, **reset readyStatus**
- **END_GAME → READY_UP:** All players clicked "Ready for Next Game" (checked via `allPlayersReady()`)

**Important:** The `readyStatus` object is reset (all players set to `false`) when:
1. Transitioning from TOKEN_TRADING to READY_UP (new turn)
2. Transitioning from TOKEN_TRADING to END_GAME (game ends)
3. This ensures players must explicitly ready-up for each phase

## Edge Cases
- Late joiner during game → show LOBBY, wait for next game
- Player disconnect during ready-up (deferred to post-MVP)
- Invalid phase transitions (should throw error or no-op)
