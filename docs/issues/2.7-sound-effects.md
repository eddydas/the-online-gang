# Issue 2.7: Sound Effects System

**Sprint:** 2 v2
**Priority:** LOW
**Estimate:** 6 hours
**Status:** TODO

## Description
Implement a sound effects system with audio feedback for key game actions: card dealing, token selection, token stealing, phase transitions, and win/loss outcomes. All sounds should be subtle, non-intrusive, and respect user preferences.

## User Story
As a player, I want audio feedback for game actions so that I have a more immersive and engaging experience, with the ability to mute sounds if I prefer.

## Acceptance Criteria
- [ ] Card dealing sound (whoosh/slide)
- [ ] Card flip sound (snap/flip)
- [ ] Token selection sound (click/tap)
- [ ] Token steal sound (negative tone/alert)
- [ ] Phase transition sound (chime/bell)
- [ ] Win sound (positive fanfare)
- [ ] Loss sound (negative tone)
- [ ] Mute toggle button in top bar
- [ ] Sound preference saved to localStorage
- [ ] Low volume by default (30-50%)
- [ ] All sounds < 1 second duration
- [ ] Works on Safari iOS (Web Audio API)

## Sound Files

### Audio Assets (to be created or sourced)
Place in `public/sounds/` directory:

- `card-deal.mp3` - Whoosh/slide sound (200-300ms)
- `card-flip.mp3` - Snap/flip sound (150-250ms)
- `token-select.mp3` - Click/tap sound (100-150ms)
- `token-steal.mp3` - Alert/negative tone (200-300ms)
- `phase-transition.mp3` - Chime/bell sound (300-500ms)
- `game-win.mp3` - Positive fanfare (500ms-1s)
- `game-loss.mp3` - Negative tone (500ms-1s)

**Sound Design Guidelines:**
- Subtle and non-intrusive
- No harsh or jarring sounds
- Poker/casino theme (but not slot machine sounds)
- Low frequency content (avoid high-pitched squeaks)
- Properly normalized volume levels

## Sound Manager Implementation

### soundManager.js
```javascript
/**
 * Sound Manager for game audio
 */
class SoundManager {
  constructor() {
    this.sounds = {};
    this.isMuted = this.loadMutePreference();
    this.volume = 0.4; // 40% volume by default

    this.initializeSounds();
  }

  /**
   * Initialize all sound files
   */
  initializeSounds() {
    const soundFiles = {
      cardDeal: '/sounds/card-deal.mp3',
      cardFlip: '/sounds/card-flip.mp3',
      tokenSelect: '/sounds/token-select.mp3',
      tokenSteal: '/sounds/token-steal.mp3',
      phaseTransition: '/sounds/phase-transition.mp3',
      gameWin: '/sounds/game-win.mp3',
      gameLoss: '/sounds/game-loss.mp3'
    };

    Object.entries(soundFiles).forEach(([key, path]) => {
      this.sounds[key] = new Audio(path);
      this.sounds[key].volume = this.volume;
      this.sounds[key].preload = 'auto'; // Preload for instant playback
    });
  }

  /**
   * Play a sound
   * @param {string} soundName - Name of sound to play
   */
  play(soundName) {
    if (this.isMuted) return;

    const sound = this.sounds[soundName];
    if (!sound) {
      console.warn(`Sound not found: ${soundName}`);
      return;
    }

    // Reset to beginning if already playing
    sound.currentTime = 0;

    sound.play().catch(err => {
      console.error(`Failed to play sound ${soundName}:`, err);
    });
  }

  /**
   * Toggle mute on/off
   */
  toggleMute() {
    this.isMuted = !this.isMuted;
    this.saveMutePreference();

    // Update UI
    this.updateMuteButton();
  }

  /**
   * Set volume (0.0 to 1.0)
   * @param {number} volume - Volume level
   */
  setVolume(volume) {
    this.volume = Math.max(0, Math.min(1, volume));

    Object.values(this.sounds).forEach(sound => {
      sound.volume = this.volume;
    });
  }

  /**
   * Load mute preference from localStorage
   * @returns {boolean}
   */
  loadMutePreference() {
    const saved = localStorage.getItem('soundMuted');
    return saved === 'true';
  }

  /**
   * Save mute preference to localStorage
   */
  saveMutePreference() {
    localStorage.setItem('soundMuted', this.isMuted.toString());
  }

  /**
   * Update mute button UI
   */
  updateMuteButton() {
    const btn = document.getElementById('mute-toggle-btn');
    if (btn) {
      btn.textContent = this.isMuted ? 'üîá' : 'üîä';
      btn.setAttribute('aria-label', this.isMuted ? 'Unmute sounds' : 'Mute sounds');
    }
  }
}

// Export singleton instance
export const soundManager = new SoundManager();
```

## UI Controls

### Mute Toggle Button (in top bar)
```html
<!-- Add to top bar in 2.5 -->
<div class="top-bar-right">
  <button id="mute-toggle-btn" class="icon-btn" aria-label="Mute sounds">
    üîä
  </button>
  <button id="poker-rankings-button" class="icon-btn" aria-label="Poker Hand Rankings">
    ?
  </button>
</div>
```

```javascript
// Event listener
document.getElementById('mute-toggle-btn')?.addEventListener('click', () => {
  soundManager.toggleMute();
});
```

## Integration Points

### Card Dealing (in cardRenderer.js)
```javascript
import { soundManager } from './soundManager.js';

export function dealCardsWithSound(cardElements) {
  cardElements.forEach((card, index) => {
    setTimeout(() => {
      card.classList.add('dealing');
      soundManager.play('cardDeal'); // Play sound

      setTimeout(() => {
        card.classList.remove('dealing');
      }, 600);
    }, index * 100);
  });
}
```

### Card Flip (in cardRenderer.js)
```javascript
export function flipCardWithSound(cardElement) {
  cardElement.classList.add('flipping');
  soundManager.play('cardFlip'); // Play sound

  setTimeout(() => {
    cardElement.classList.remove('card-face-down');
    cardElement.classList.add('card-face-up');
  }, 300);

  setTimeout(() => {
    cardElement.classList.remove('flipping');
  }, 600);
}
```

### Token Selection (in tokenRenderer.js)
```javascript
import { soundManager } from './soundManager.js';

export function handleTokenClick(tokenNumber, playerId) {
  const tokenElement = document.querySelector(`.token[data-number="${tokenNumber}"]`);
  if (!tokenElement) return;

  const currentOwnerId = tokenElement.dataset.ownerId;

  if (currentOwnerId && currentOwnerId !== playerId) {
    // Token is being stolen
    soundManager.play('tokenSteal'); // Steal sound
    animateTokenSteal(tokenElement, playerId);
  } else {
    // Token is being selected
    soundManager.play('tokenSelect'); // Select sound
    animateTokenSelect(tokenElement);
  }

  // ... rest of logic ...
}
```

### Phase Transition (in gameController.js)
```javascript
import { soundManager } from './soundManager.js';

export function advancePhase() {
  // ... existing phase transition logic ...

  soundManager.play('phaseTransition'); // Play transition sound

  // ... update state and UI ...
}
```

### Win/Loss (in endGameRenderer.js)
```javascript
import { soundManager } from './soundManager.js';

export function renderEndGameResults(gameState, winLossResult) {
  // ... existing render logic ...

  if (winLossResult.isWin) {
    soundManager.play('gameWin'); // Win sound
  } else {
    soundManager.play('gameLoss'); // Loss sound
  }

  // ... display results ...
}
```

## Safari iOS Considerations

### Autoplay Policy
Safari iOS requires user interaction before playing audio. Solution:

```javascript
/**
 * Initialize audio on first user interaction
 */
let audioInitialized = false;

function initializeAudioOnFirstInteraction() {
  if (audioInitialized) return;

  // Play silent audio to unlock Web Audio API
  Object.values(soundManager.sounds).forEach(sound => {
    sound.play().then(() => sound.pause()).catch(() => {});
  });

  audioInitialized = true;

  // Remove listener after first interaction
  document.removeEventListener('click', initializeAudioOnFirstInteraction);
  document.removeEventListener('touchstart', initializeAudioOnFirstInteraction);
}

// Add listeners for first user interaction
document.addEventListener('click', initializeAudioOnFirstInteraction);
document.addEventListener('touchstart', initializeAudioOnFirstInteraction);
```

### Audio Format Compatibility
Safari iOS supports:
- ‚úÖ MP3 (recommended)
- ‚úÖ AAC/M4A
- ‚ùå OGG Vorbis (not supported)

Use MP3 format for maximum compatibility.

## Volume Control (Optional Enhancement)

### Volume Slider
```html
<div class="volume-control">
  <button id="mute-toggle-btn" class="icon-btn">üîä</button>
  <input
    type="range"
    id="volume-slider"
    min="0"
    max="100"
    value="40"
    aria-label="Volume"
  />
</div>
```

```javascript
// Volume slider event
document.getElementById('volume-slider')?.addEventListener('input', (e) => {
  const volume = parseInt(e.target.value) / 100;
  soundManager.setVolume(volume);
});
```

## Testing Checklist
- [ ] Card deal sound plays when cards are dealt
- [ ] Card flip sound plays when cards flip
- [ ] Token select sound plays when token is selected
- [ ] Token steal sound plays when token is stolen
- [ ] Phase transition sound plays when phase changes
- [ ] Win sound plays when game is won
- [ ] Loss sound plays when game is lost
- [ ] Mute button toggles sound on/off
- [ ] Mute preference saved to localStorage
- [ ] Mute preference persists after page reload
- [ ] Sounds work on Safari iOS (after user interaction)
- [ ] No sound overlap or clipping
- [ ] Volume levels are appropriate (not too loud)
- [ ] All sounds < 1 second duration

## Accessibility
- [ ] Mute button has aria-label
- [ ] Mute button keyboard accessible (Tab, Enter)
- [ ] Visual feedback for mute state (üîä vs üîá)
- [ ] Sounds don't interfere with screen readers

## Files to Create/Modify
- `src/browser/soundManager.js` - New sound manager module
- `public/sounds/` - Create directory for audio files
- `src/browser/cardRenderer.js` - Add sound triggers
- `src/browser/tokenRenderer.js` - Add sound triggers
- `src/browser/gameController.js` - Add phase transition sound
- `src/browser/endGameRenderer.js` - Add win/loss sounds
- `src/browser/main.js` - Initialize sound manager

## Sound Asset Sources (Free Options)
- **freesound.org** - Creative Commons sounds
- **zapsplat.com** - Free sound effects (attribution required)
- **mixkit.co** - Free sound effects (no attribution)
- **Create custom** - GarageBand, Audacity (simple click/whoosh sounds)

## Dependencies
- Issue 2.5 (Top Bar UI) - Mute button location
- Issue 2.6 (Animations) - Sync sounds with animations

## Notes
- Keep sounds subtle - this is a card game, not an arcade
- Preload sounds for instant playback (no delay)
- Safari iOS requires user interaction before audio plays
- MP3 format for maximum browser compatibility
- Default to 40% volume (not too loud)
- Allow users to mute - some players prefer silence

## Definition of Done
- [ ] All sound effects implemented and playing
- [ ] Mute toggle button works correctly
- [ ] Mute preference saved to localStorage
- [ ] Sounds work on Safari iOS (after user interaction)
- [ ] No audio overlap or clipping issues
- [ ] Volume levels appropriate and balanced
- [ ] Tested on iPhone, iPad, macOS Safari
- [ ] Code passes typecheck
- [ ] Approved by product owner
